<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Studio - Single Line Toolbar</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME CONFIGURATION --- */
        :root {
            /* Backgrounds */
            --bg-app: #15161c;          
            --bg-panel: #191a22;        
            --bg-element: #2f3141;      
            --bg-card: #191a22;         
            --bg-inner: #1c1d26;        
            
            /* Borders */
            --border-color: #2f3141;    
            --border-input: #404159;    

            /* Text Colors */
            --text-header: #d2d3e0;     
            --text-white: #ffffff;      
            --text-body: #fafaff;       
            --text-btn: #f3f3f6;        
            --text-muted: #858699;      
            
            /* Accents */
            --accent-purple: #ae9dec;   
            
            /* Active State */
            --active-bg: rgba(174, 157, 236, 0.15);
            --active-color: #ae9dec;
            --active-border: #ae9dec;

            /* Dimensions */
            --header-height: 3.5rem;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-app); 
            color: var(--text-body); 
            overflow: hidden; 
            font-size: 13px;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-element); border-radius: 3px; }

        /* Hide Scrollbar for Filters */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Checkered Background */
        .bg-checker {
            background-color: var(--bg-inner);
            background-image:
              linear-gradient(45deg, #262730 25%, transparent 25%),
              linear-gradient(-45deg, #262730 25%, transparent 25%),
              linear-gradient(45deg, transparent 75%, #262730 75%),
              linear-gradient(-45deg, transparent 75%, #262730 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        /* --- BUTTON STYLES --- */
        .filter-btn {
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .filter-btn:hover {
            background-color: var(--bg-element);
        }

        .btn-active { 
            background-color: var(--active-bg) !important; 
            color: var(--active-color) !important; 
            border-color: var(--active-border) !important; 
        }
        .btn-active i { color: var(--active-color) !important; }

        .modal-overlay { z-index: 50; }

        /* Dropdown Styles */
        .dropdown-menu {
            position: fixed; 
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            min-width: 180px;
            padding: 4px 0;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 8px 12px;
            font-size: 13px;
            color: var(--text-body);
            cursor: pointer;
        }
        .dropdown-item:hover { background-color: var(--bg-element); }
        .custom-checkbox { accent-color: var(--accent-purple); width: 14px; height: 14px; margin-right: 8px; }

        /* TOOLTIP STYLE */
        #tag-tooltip {
            position: fixed;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            padding: 4px 0;
            min-width: 140px;
            pointer-events: auto;
        }
        #tag-tooltip.show { display: block; }
        .tooltip-item {
            padding: 6px 12px;
            font-size: 12px;
            color: var(--text-body);
            cursor: pointer;
            transition: background 0.15s;
        }
        .tooltip-item:hover {
            background-color: var(--bg-element);
            color: var(--accent-purple);
        }

        /* --- MODEL CARD TOOLTIP --- */
        #model-card-tooltip {
            position: fixed;
            width: 280px;
            background-color: #191a22c3;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.8);
						backdrop-filter: blur(12px);
            z-index: 500;
            pointer-events: none; /* Allows clicking through to the card */
            opacity: 0;
            transform: scale(0.95);
            /* Note: We do NOT transition top/left here to avoid lag when following cursor */
            transition: opacity 0.2s ease, transform 0.2s ease;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #model-card-tooltip.show {
            opacity: 1;
            transform: scale(1);
        }
        .caps-pill {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-element);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        /* TOAST STYLES */
        .toast {
            background: var(--bg-element);
            border: 1px solid var(--border-color);
            color: var(--text-white);
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            animation: toast-in 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toast-out {
            to { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body class="flex h-screen w-screen" onclick="closeAllDropdowns(event)">

    <!-- ================= TOAST CONTAINER ================= -->
    <div id="toast-container" class="fixed bottom-8 left-1/2 -translate-x-1/2 flex flex-col gap-2 z-[100] pointer-events-none"></div>

    <!-- ================= GLOBAL TOOLTIP CONTAINER ================= -->
    <div id="tag-tooltip" onmouseenter="cancelTooltipHide()" onmouseleave="hideTooltipWithDelay()"></div>

    <!-- ================= MODEL INFO TOOLTIP ================= -->
    <div id="model-card-tooltip"></div>

    <!-- ================= LEFT SIDEBAR ================= -->
    <aside class="w-16 md:w-64 flex-shrink-0 border-r border-theme bg-theme-panel flex flex-col justify-between transition-colors" style="background-color: #0f0f12; border-color: var(--border-color);">
        <div>
            <div class="h-[var(--header-height)] flex items-center px-4 border-b border-theme cursor-pointer hover:bg-white/5 transition-colors" style="border-color: var(--border-color);">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center font-bold text-white text-xs mr-3">C</div>
                <div class="hidden md:block overflow-hidden">
                    <div class="text-xs font-bold text-white truncate">Connor's Workspace</div>
                    <div class="text-[10px] text-gray-500 flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Online
                    </div>
                </div>
                <i data-lucide="chevrons-up-down" class="ml-auto w-3 h-3 text-gray-500 hidden md:block"></i>
            </div>

            <div class="p-2 space-y-1 mt-2">
                <button onclick="navigateTo('session')" id="nav-home" class="w-full flex items-center gap-3 px-3 py-2 text-[13px] font-medium text-[var(--text-muted)] rounded-md hover:bg-white/10 hover:text-white transition-colors">
                    <i data-lucide="home" class="w-4 h-4"></i> <span class="hidden md:block">Home</span>
                </button>
                <button onclick="navigateTo('session')" class="w-full flex items-center gap-3 px-3 py-2 text-[13px] font-medium text-[var(--text-muted)] rounded-md hover:bg-white/10 hover:text-white transition-colors">
                    <i data-lucide="hard-drive" class="w-4 h-4"></i> <span class="hidden md:block">Drive</span>
                </button>
                <button onclick="navigateTo('models')" id="nav-models" class="w-full flex items-center gap-3 px-3 py-2 text-[13px] font-medium text-[var(--text-muted)] rounded-md hover:bg-white/10 hover:text-white transition-colors">
                    <i data-lucide="box" class="w-4 h-4"></i> <span class="hidden md:block">Models</span>
                </button>
            </div>
        </div>
        <div class="p-2 border-t border-theme space-y-1" style="border-color: var(--border-color);">
            <button class="w-full flex items-center gap-3 px-3 py-2 text-[13px] font-medium text-[var(--text-muted)] rounded-md hover:bg-white/10 hover:text-white transition-colors">
                <i data-lucide="help-circle" class="w-4 h-4"></i> <span class="hidden md:block">Help Center</span>
            </button>
        </div>
    </aside>

    <!-- ================= MAIN CONTENT AREA ================= -->
    <main class="flex-1 relative overflow-hidden" style="background-color: var(--bg-app);">
        
        <!-- VIEW 1: SESSION PAGE -->
        <div id="view-session" class="h-full flex flex-col">
            <header class="h-[var(--header-height)] border-b flex items-center justify-between px-4" style="background-color: var(--bg-panel); border-color: var(--border-color);">
                <div class="flex items-center gap-2 text-[13px] text-[var(--text-muted)]">
                    <i data-lucide="panel-left" class="w-4 h-4"></i>
                    <span>Session</span>
                    <span class="opacity-50">/</span>
                    <span class="text-[var(--text-body)] font-medium">Untitled</span>
                </div>
                <div class="flex items-center gap-2">
                    <button class="px-3 py-1.5 text-[13px] font-medium text-white rounded border hover:bg-white/10 transition-colors" style="background-color: var(--bg-element); border-color: var(--border-color);">Download All</button>
                </div>
            </header>

            <div class="flex flex-1 overflow-hidden">
                <div class="w-80 border-r p-4 overflow-y-auto flex-shrink-0" style="background-color: var(--bg-panel); border-color: var(--border-color);">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-bold text-white">2D Generator</h2>
                        <button class="text-xs text-[var(--accent-purple)] flex items-center gap-1"><i data-lucide="lightbulb" class="w-3 h-3"></i> Ideas</button>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-[var(--text-muted)] font-medium mb-1.5 block">Model</label>
                        <button onclick="openModal()" class="w-full flex items-center gap-3 hover:bg-white/5 hover:ring-1 hover:ring-indigo-500 border rounded-lg p-2 transition-all text-left group" style="background-color: var(--bg-element); border-color: var(--border-color);">
                            <div id="selected-model-icon" class="w-10 h-10 rounded bg-gradient-to-br from-indigo-900 to-slate-900 flex items-center justify-center text-white border border-slate-600 bg-cover bg-center overflow-hidden">
                                <span class="text-xs font-bold">flux</span>
                            </div>
                            <div class="flex-1 overflow-hidden">
                                <div id="selected-model-title" class="text-[13px] font-bold text-white group-hover:text-indigo-300 transition-colors truncate">FLUX.1 [dev]</div>
                                <div id="selected-model-author" class="text-[10px] text-[var(--text-muted)] truncate">Click to change model</div>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-[var(--text-muted)] flex-shrink-0"></i>
                        </button>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-[var(--text-muted)] font-medium mb-1.5 block">Prompt</label>
                        <textarea class="w-full border rounded-lg p-3 text-[13px] text-white h-32 focus:ring-1 focus:ring-indigo-500 focus:outline-none resize-none" style="background-color: var(--bg-app); border-color: var(--border-color);" placeholder="Describe your game asset..."></textarea>
                    </div>
                     <button class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-2.5 rounded-lg flex items-center justify-center gap-2 transition-colors text-[13px]">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> Forge 2D
                    </button>
                </div>
                <div class="flex-1 flex items-center justify-center relative p-8" style="background-color: var(--bg-app);">
                    <div class="grid grid-cols-3 gap-4 max-w-4xl w-full opacity-60">
                        <div class="aspect-square rounded border" style="background-color: var(--bg-element); border-color: var(--border-color);"></div>
                        <div class="aspect-square rounded border" style="background-color: var(--bg-element); border-color: var(--border-color);"></div>
                        <div class="aspect-square rounded border" style="background-color: var(--bg-element); border-color: var(--border-color);"></div>
                    </div>
                    <div class="absolute text-center">
                         <p class="text-[var(--text-muted)]">Select a style from the sidebar to open the Model Selector.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: MODELS PAGE -->
        <div id="view-models" class="h-full flex flex-col hidden">
            <header class="h-[var(--header-height)] border-b flex items-center justify-between px-8 flex-shrink-0" style="background-color: var(--bg-panel); border-color: var(--border-color);">
                <div class="text-[13px] text-white font-semibold flex items-center gap-2">
                    <span class="text-[var(--text-muted)]">Home</span> <i data-lucide="chevron-right" class="w-3 h-3 text-gray-600"></i> Models
                </div>
                <div class="flex items-center gap-3">
                    <button class="px-3 py-1.5 text-[13px] font-medium bg-purple-600 text-white rounded hover:bg-purple-500 flex items-center gap-2 shadow-[0_0_10px_rgba(147,51,234,0.3)]">
                        <i data-lucide="plus" class="w-3 h-3"></i> Train a Model
                    </button>
                    <button class="px-3 py-1.5 text-[13px] font-medium text-gray-300 border rounded hover:bg-white/5 flex items-center gap-2" style="border-color: var(--border-color);">
                        <i data-lucide="upload" class="w-3 h-3"></i> Bring in a Model
                    </button>
                </div>
            </header>
            <div class="flex-1 flex flex-col overflow-hidden" id="page-dashboard-container"></div>
        </div>
    </main>

    <!-- ================= MODAL OVERLAY ================= -->
    <div id="modal-overlay" class="modal-overlay fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center hidden opacity-0 transition-opacity duration-200">
        <div class="w-[75vw] max-w-[1150px] h-[85vh] rounded-xl border shadow-2xl flex flex-col overflow-hidden transform scale-95 transition-transform duration-200" id="modal-content" style="background-color: var(--bg-panel); border-color: var(--border-color);">
            <div class="flex-1 flex flex-col overflow-hidden" id="modal-dashboard-container" style="background-color: var(--bg-app);"></div>
        </div>
    </div>

    <!-- ================= FLOATING DROPDOWNS ================= -->
    <div id="dropdown-tags" class="dropdown-menu"><div id="tags-list-container"></div></div>
    <div id="dropdown-capabilities" class="dropdown-menu"><div id="caps-list-container"></div></div>
    <div id="dropdown-authors" class="dropdown-menu"><div id="authors-list-container"></div></div>
    <div id="dropdown-date" class="dropdown-menu">
        <div onclick="setDateFilter('all')" class="dropdown-item">Any Time</div>
        <div onclick="setDateFilter(7)" class="dropdown-item">Last 7 Days</div>
        <div onclick="setDateFilter(30)" class="dropdown-item">Last 30 Days</div>
    </div>
    <div id="dropdown-sort" class="dropdown-menu">
        <div onclick="setSort('recent')" class="dropdown-item">Recently Used</div>
        <div onclick="setSort('oldest')" class="dropdown-item">Oldest First</div>
        <div onclick="setSort('az')" class="dropdown-item">Name (A-Z)</div>
        <div onclick="setSort('za')" class="dropdown-item">Name (Z-A)</div>
    </div>

    <!-- ================= LOGIC ================= -->
    <script>
        const TAG_POOL = ["Consectetur adipiscing", "Sed do eiusmod", "Ut enim ad minim", "Quis nostrud", "Character", "Landscape", "Sci-Fi"];
        const CAP_POOL = ["Text-to-Image", "Image-to-Image", "In-painting", "Upscaling"];
        const AUTHORS = ["Galactic Studios", "Stability AI", "Black Forest Labs", "Midjourney"];
        const IMAGE_IDS = ['1618005182384-a83a8bd57fbe','1635326444826-06c8f84991a3','1646483175488-4a53cc3d6990','1614728263952-84ea2563bc10','1621600411688-4be43a7d27a7','1524704654690-b56c05c78a00','1518531933037-9a847ec7595e','1480796927426-f609979314bd','1534447677768-be436bb09401','1619983081563-430f63602796','1655712677028-1c55325292d4','1500964757637-c85e8a162699'];

        const getRandomImage = (seed) => `https://images.unsplash.com/photo-${IMAGE_IDS[seed % IMAGE_IDS.length]}?auto=format&fit=crop&w=400&h=400&q=80`;
        
        const getRandomTags = () => {
            const shuffled = [...TAG_POOL].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, Math.floor(Math.random() * 3) + 1);
        };
        const getRandomCaps = () => CAP_POOL.sort(() => 0.5 - Math.random()).slice(0, 2);

        const generateMockData = (category, count) => {
            return Array.from({ length: count }).map((_, i) => {
                const daysAgo = Math.floor(Math.random() * 60);
                const seed = category.charCodeAt(0) + i + (daysAgo * 2);
                let title = `${category} Model ${i + 1}`;
                let badges = [];
                let image = getRandomImage(seed);
                let author = AUTHORS[Math.floor(Math.random() * AUTHORS.length)];
                let tags = getRandomTags();
                let caps = getRandomCaps();
                
                // Description Generator
                let description = `A high-fidelity ${category.toLowerCase()} model optimized for ${tags[0].toLowerCase()}. Features excellent coherence and style consistency for standard production workflows.`;
                
                if (category === 'Team') {
                    author = 'Galactic Studios';
                    if (i === 0) { title = 'Big Catch: Fish'; image = 'https://images.unsplash.com/photo-1522069169874-c58ec4b76be5?w=400&h=400&fit=crop'; description = "Internal asset generator for the 'Big Catch' project. Specialized in aquatic life forms."; }
                    else if (i === 1) { title = 'Big Catch: Plants'; image = 'https://images.unsplash.com/photo-1530595467537-0b5996c41f2d?w=400&h=400&fit=crop'; description = "Vegetation generator for underwater biomes. Handles kelp, coral, and sea grass variations."; }
                } else if (category === 'Base') {
                    author = 'Black Forest Labs';
                    image = 'https://i.ibb.co/23tV2VS3/2-Img.png';
                    if (i === 0) { title = 'Stable Diffusion XL'; badges = ['NEW', 'POPULAR']; description = "The latest iteration of SDXL. Unmatched photorealism and prompt adherence."; }
                    else if (i === 1) { title = 'FLUX.1 [pro]'; description = "State-of-the-art image generation with superior detail and lighting composition."; }
                    else if (i === 2) { title = 'Stable Diffusion 3'; description = "Next generation architecture utilizing MMDiT for better text handling."; }
                    else if (i === 3) { title = 'FLUX.1 SRPO [dev]'; description = "Optimized for speed without sacrificing quality. Ideal for rapid iteration."; }
                }
                
                return { 
                    id: `${category}-${i}`, title, author, daysAgo,
                    date: new Date(Date.now() - (daysAgo * 24 * 60 * 60 * 1000)),
                    isFavorite: Math.random() < 0.15, image, badges, category,
                    tags: tags, capabilities: caps, description
                };
            });
        };

        const rawData = {
            'team': { title: "Your Team's Models", items: generateMockData('Team', 13) },
            'base': { title: "Base Models", items: generateMockData('Base', 13) },
            'layer': { title: "Models by Layer", items: generateMockData('Layer', 13) }
        };

        const appState = { searchQuery: '', filters: { onlyTeam: false, onlyFavorites: false, selectedTags: new Set(), selectedCaps: new Set(), selectedAuthors: new Set(), dateRangeDays: 'all' }, sort: 'recent', expandedSections: { 'team': false, 'base': false, 'layer': false } };

        // --- TOAST SYSTEM ---
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerHTML = `<i data-lucide="info" class="w-4 h-4 text-[var(--accent-purple)]"></i> ${message}`;
            container.appendChild(el);
            lucide.createIcons();
            setTimeout(() => { el.style.animation = 'toast-out 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards'; setTimeout(() => el.remove(), 300); }, 3000);
        }

        // --- TAG TOOLTIP LOGIC ---
        let tooltipTimer = null;
        const tooltipEl = document.getElementById('tag-tooltip');
        window.showTagTooltip = (e, tagsString) => {
            clearTimeout(tooltipTimer);
            const tags = JSON.parse(decodeURIComponent(tagsString));
            if (!tags || tags.length === 0) return;
            tooltipEl.innerHTML = tags.map(tag => `<div class="tooltip-item" onclick="applyTagFilter('${tag}')">${tag}</div>`).join('');
            const rect = e.currentTarget.getBoundingClientRect();
            tooltipEl.style.top = (rect.bottom + 6) + 'px';
            tooltipEl.style.left = rect.left + 'px';
            tooltipEl.classList.add('show');
        };
        window.hideTooltipWithDelay = () => { tooltipTimer = setTimeout(() => { tooltipEl.classList.remove('show'); }, 800); };
        window.cancelTooltipHide = () => { clearTimeout(tooltipTimer); };
        window.applyTagFilter = (tag) => {
            if (!appState.filters.selectedTags.has(tag)) {
                appState.filters.selectedTags.add(tag);
                showToast(`Filtering by ${tag}`);
                const inputs = document.querySelectorAll('#tags-list-container input');
                inputs.forEach(inp => { if(inp.value === tag) inp.checked = true; });
                refreshGrid();
            }
            tooltipEl.classList.remove('show');
        };

// --- MODEL CARD TOOLTIP LOGIC ---
        const cardTooltipEl = document.getElementById('model-card-tooltip');
        let cardTooltipTimer = null; // Variable to hold the timer
        const TOOLTIP_DELAY = 1500;   // Delay in milliseconds
        
        // Helper to calculate position relative to cursor with collision detection
        const updateTooltipPos = (x, y) => {
            const offset = 16; 
            const width = cardTooltipEl.offsetWidth;
            const height = cardTooltipEl.offsetHeight;
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            let left = x + offset; 
            let top = y + offset;
            
            // Collision Check: Right Edge
            if (left + width > winW - 16) {
                left = x - width - offset;
            }
            
            // Collision Check: Bottom Edge
            if (top + height > winH - 16) {
                top = y - height - offset;
            }
            
            cardTooltipEl.style.left = left + 'px';
            cardTooltipEl.style.top = top + 'px';
        };

        window.showCardTooltip = (e, id) => {
            // 1. Clear any pending timer from previous hovers
            clearTimeout(cardTooltipTimer);

            // 2. Prepare the data immediately (so we can track cursor position while waiting)
            let item = null;
            Object.values(rawData).forEach(section => {
                const found = section.items.find(i => i.id === id);
                if(found) item = found;
            });
            if(!item) return;

            const capsHTML = item.capabilities.map(c => `<span class="caps-pill">${c}</span>`).join('');
            
            cardTooltipEl.innerHTML = `
                <div class="flex items-start justify-between">
                    <div>
                        <div class="text-[14px] font-bold text-white">${item.title}</div>
                        <div class="text-[11px] text-[var(--text-muted)] mt-0.5">by ${item.author}</div>
                    </div>
                    ${item.isFavorite ? '<i data-lucide="heart" class="w-4 h-4 text-[var(--accent-purple)] fill-current"></i>' : ''}
                </div>
                
                <div class="text-[12px] text-[var(--text-body)] leading-relaxed border-t border-b border-[var(--border-color)] py-3">
                    ${item.description}
                </div>

                <div>
                    <div class="text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-wider mb-2">Capabilities</div>
                    <div class="flex flex-wrap gap-1.5">
                        ${capsHTML}
                    </div>
                </div>
            `;
            
            lucide.createIcons();

            // 3. Update position immediately (while invisible)
            updateTooltipPos(e.clientX, e.clientY);

            // 4. Start the delay timer
            cardTooltipTimer = setTimeout(() => {
                cardTooltipEl.classList.add('show');
            }, TOOLTIP_DELAY);
        };

        window.moveCardTooltip = (e) => {
            // Update position even if hidden, so when it appears it's at the correct spot
            updateTooltipPos(e.clientX, e.clientY);
        };

        window.hideCardTooltip = () => {
            // 1. Cancel the timer if the user leaves before the delay ends
            clearTimeout(cardTooltipTimer);
            
            // 2. Hide the tooltip
            cardTooltipEl.classList.remove('show');
        };

        function initApp() {
            const populate = (id, pool, setKey) => {
                const c = document.getElementById(id);
                pool.forEach(val => {
                    const d = document.createElement('div');
                    d.className = 'dropdown-item';
                    d.innerHTML = `<input type="checkbox" class="custom-checkbox bg-transparent border-slate-500 rounded" value="${val}"> ${val}`;
                    d.onclick = (e) => { if(e.target.tagName !== 'INPUT') d.querySelector('input').checked = !d.querySelector('input').checked; toggleFilterSet(setKey, val); };
                    c.appendChild(d);
                });
            };
            populate('tags-list-container', TAG_POOL, 'selectedTags');
            populate('caps-list-container', CAP_POOL, 'selectedCaps');
            populate('authors-list-container', AUTHORS, 'selectedAuthors');
            navigateTo('session');
        }

        function filterItems(items) {
            let result = [...items];
            if (appState.searchQuery) result = result.filter(i => i.title.toLowerCase().includes(appState.searchQuery.toLowerCase()));
            if (appState.filters.onlyFavorites) result = result.filter(i => i.isFavorite);
            if (appState.filters.selectedTags.size > 0) result = result.filter(i => i.tags.some(t => appState.filters.selectedTags.has(t)));
            if (appState.filters.selectedCaps.size > 0) result = result.filter(i => i.capabilities.some(c => appState.filters.selectedCaps.has(c)));
            if (appState.filters.selectedAuthors.size > 0) result = result.filter(i => appState.filters.selectedAuthors.has(i.author));
            if (appState.filters.dateRangeDays !== 'all') { const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - appState.filters.dateRangeDays); result = result.filter(i => i.date >= cutoff); }
            result.sort((a, b) => {
                if (appState.sort === 'recent') return a.daysAgo - b.daysAgo;
                if (appState.sort === 'oldest') return b.daysAgo - a.daysAgo;
                if (appState.sort === 'az') return a.title.localeCompare(b.title);
                if (appState.sort === 'za') return b.title.localeCompare(a.title);
                return 0;
            });
            return result;
        }

        function getCardHTML(item) {
            const badges = item.badges.map(b => `<span class="px-1.5 py-0.5 rounded text-[9px] font-bold border shadow-sm bg-emerald-500/90 text-white border-emerald-400/50">${b}</span>`).join('');
            let fallbackIcon = item.category === 'Team' ? 'fish' : 'zap';
            const firstTag = item.tags.length > 0 ? item.tags[0] : null;
            const extraTags = item.tags.length > 1 ? item.tags.slice(1) : [];
            const hiddenCount = extraTags.length;
            const hiddenTagsJson = encodeURIComponent(JSON.stringify(extraTags));
            const tagsHTML = firstTag ? `
                <div class="flex items-center gap-1.5 mt-2">
                    <span onclick="event.stopPropagation(); applyTagFilter('${firstTag}')" class="truncate px-1.5 py-0.5 rounded text-[10px] font-medium text-[var(--text-body)] bg-white/10 border border-white/10 max-w-[70%] cursor-pointer hover:bg-white/20 transition-colors">${firstTag}</span>
                    ${hiddenCount > 0 ? `<span onmouseenter="showTagTooltip(event, '${hiddenTagsJson}')" onmouseleave="hideTooltipWithDelay()" class="px-1.5 py-0.5 rounded text-[10px] font-medium text-[var(--text-body)] bg-white/10 border border-white/10 cursor-help hover:bg-white/20 transition-colors">+${hiddenCount}</span>` : ''}
                </div>` : '';

            // Added onmousemove to track cursor
            return `
                <div 
                    onmouseenter="showCardTooltip(event, '${item.id}')" 
                    onmousemove="moveCardTooltip(event)" 
                    onmouseleave="hideCardTooltip()"
                    onclick="selectModel('${item.id}')" 
                    class="fade-in group relative aspect-square w-full overflow-hidden rounded-xl border transition-all hover:shadow-[0_0_25px_rgba(99,102,241,0.25)] cursor-pointer select-none" 
                    style="background-color: var(--bg-card); border-color: var(--border-color);"
                >
                    <div class="absolute inset-0 bg-checker opacity-30"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-slate-700"><i data-lucide="${fallbackIcon}" class="w-16 h-16 opacity-50"></i></div>
                    ${item.isFavorite ? '<div class="absolute top-3 right-3 z-20 text-[var(--accent-purple)] drop-shadow-md"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></div>' : ''}
                    <div class="absolute top-3 left-3 z-20 flex gap-1">${badges}</div>
                    <img src="${item.image}" class="absolute inset-0 h-full w-full object-cover transition-transform duration-700 ease-in-out group-hover:scale-110 z-10" loading="lazy" onerror="this.style.display='none'" />
                    <div class="absolute inset-0 bg-gradient-to-t from-[#0f0f12] via-[#0f0f12]/40 to-transparent opacity-90 z-10 pointer-events-none"></div>
                    <div class="absolute bottom-0 left-0 w-full p-3 z-20">
                        <h3 class="mb-1 truncate text-[13px] font-bold text-white drop-shadow-md">${item.title}</h3>
                        <div class="flex items-center gap-2 text-[10px] text-[var(--text-muted)]">
                            <div class="flex h-4 w-4 items-center justify-center rounded-full bg-indigo-600 text-[8px] font-bold text-white">${item.author[0]}</div>
                            <span class="truncate text-[var(--text-body)]">${item.author}</span>
                        </div>
                        ${tagsHTML}
                    </div>
                </div>`;
        }

        function getPreviewHTML(items, key, containerId, hiddenCount) {
            const mosaic = items.map(i => `<div class="relative w-full h-full rounded-sm overflow-hidden" style="background-color: var(--bg-inner);"><img src="${i.image}" class="absolute inset-0 w-full h-full object-cover opacity-60"></div>`).join('');
            return `
                <div onclick="toggleSection('${key}', '${containerId}')" class="fade-in aspect-square w-full rounded-xl border p-2.5 cursor-pointer group relative hover:border-[var(--accent-purple)] transition-all" style="background-color: var(--bg-card); border-color: var(--border-color);">
                    <div class="grid h-full w-full grid-cols-3 grid-rows-3 gap-2">${mosaic}</div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center rounded-xl backdrop-blur-sm opacity-0 transition-opacity duration-300 group-hover:opacity-100" style="background-color: rgba(21,22,28,0.7);">
                        <span class="font-bold text-white text-sm">View All</span>
                        <span class="text-[10px] font-medium mt-0.5" style="color: var(--accent-purple);">+${hiddenCount} Models</span>
                    </div>
                </div>`;
        }

        function initDashboard(containerId) {
            const container = document.getElementById(containerId);
            const isModal = containerId === 'modal-dashboard-container';
            
            const controlsHTML = `
            <div class="w-full z-30 border-b" style="background-color: var(--bg-app); border-color: var(--border-color);">
                <div class="px-6 py-4 flex flex-row items-center gap-4">
                    <div class="w-64 flex-shrink-0">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-[var(--text-muted)]"></i>
                            <input oninput="handleSearch(this.value)" type="text" placeholder="Search by name..." class="w-full rounded-lg py-2 pl-10 pr-4 text-[13px] text-white placeholder-[var(--text-muted)] border focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all" style="background-color: var(--bg-element); border-color: var(--border-input);">
                        </div>
                    </div>
                    
                    <div class="flex-1 min-w-0 relative overflow-hidden group" id="filter-wrapper-${containerId}">
                        <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pr-8" id="filter-scroll-${containerId}" onscroll="updateScrollState('${containerId}')">
                            <button onclick="toggleBooleanFilter('onlyTeam')" id="${containerId}-btn-team" class="filter-btn group flex items-center gap-2 rounded-lg border bg-transparent px-3 py-2 text-[13px] font-medium text-[var(--text-btn)] hover:text-white transition-all whitespace-nowrap flex-shrink-0" style="border-color: var(--border-color);">
                                <i data-lucide="users" class="w-3.5 h-3.5"></i> By My Team
                            </button>
                            <button onclick="toggleDropdown(event, 'dropdown-tags')" id="${containerId}-btn-tags" class="filter-btn group flex items-center gap-2 rounded-lg border bg-transparent px-3 py-2 text-[13px] font-medium text-[var(--text-btn)] hover:text-white transition-all whitespace-nowrap flex-shrink-0" style="border-color: var(--border-color);">
                                <i data-lucide="tag" class="w-3.5 h-3.5"></i> Tags <i data-lucide="chevron-down" class="w-3 h-3 text-[var(--text-muted)]"></i>
                            </button>
                            <button onclick="toggleDropdown(event, 'dropdown-capabilities')" id="${containerId}-btn-caps" class="filter-btn group flex items-center gap-2 rounded-lg border bg-transparent px-3 py-2 text-[13px] font-medium text-[var(--text-btn)] hover:text-white transition-all whitespace-nowrap flex-shrink-0" style="border-color: var(--border-color);">
                                <i data-lucide="layers" class="w-3.5 h-3.5"></i> Capabilities <i data-lucide="chevron-down" class="w-3 h-3 text-[var(--text-muted)]"></i>
                            </button>
                            <button onclick="toggleDropdown(event, 'dropdown-authors')" id="${containerId}-btn-auth" class="filter-btn group flex items-center gap-2 rounded-lg border bg-transparent px-3 py-2 text-[13px] font-medium text-[var(--text-btn)] hover:text-white transition-all whitespace-nowrap flex-shrink-0" style="border-color: var(--border-color);">
                                <i data-lucide="user" class="w-3.5 h-3.5"></i> Created By <i data-lucide="chevron-down" class="w-3 h-3 text-[var(--text-muted)]"></i>
                            </button>
                            <button onclick="toggleDropdown(event, 'dropdown-date')" id="${containerId}-btn-date" class="filter-btn group flex items-center gap-2 rounded-lg border bg-transparent px-3 py-2 text-[13px] font-medium text-[var(--text-btn)] hover:text-white transition-all whitespace-nowrap flex-shrink-0" style="border-color: var(--border-color);">
                                <i data-lucide="calendar" class="w-3.5 h-3.5"></i> Created Date <i data-lucide="chevron-down" class="w-3 h-3 text-[var(--text-muted)]"></i>
                            </button>
                            <button onclick="toggleBooleanFilter('onlyFavorites')" id="${containerId}-btn-fav" class="filter-btn group flex items-center gap-2 rounded-lg border bg-transparent px-3 py-2 text-[13px] font-medium text-[var(--text-btn)] hover:text-white transition-all whitespace-nowrap flex-shrink-0" style="border-color: var(--border-color);">
                                <i data-lucide="heart" class="w-3.5 h-3.5"></i> Favorited
                            </button>
                        </div>
                        <div id="fade-right-${containerId}" class="absolute right-0 top-0 bottom-0 w-12 pointer-events-none transition-opacity duration-300 opacity-0" style="background: linear-gradient(to left, var(--bg-app), transparent);"></div>
                    </div>

                    <div class="flex-shrink-0 flex items-center gap-3">
                        <button onclick="toggleDropdown(event, 'dropdown-sort')" class="justify-center flex items-center gap-2 rounded-lg border px-4 py-2 text-[13px] font-medium text-[var(--text-btn)] hover:bg-white/10 transition-all whitespace-nowrap" style="background-color: var(--bg-element); border-color: var(--border-color);">
                            <i data-lucide="layers" class="w-3.5 h-3.5"></i> <span class="sort-btn-label">Recently Used</span> <i data-lucide="chevron-down" class="w-3 h-3 text-[var(--text-muted)] ml-1"></i>
                        </button>
                        ${isModal ? `<button onclick="closeModal()" class="p-2 text-[var(--text-muted)] hover:text-white hover:bg-white/10 rounded-lg transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>` : ''}
                    </div>
                </div>
            </div>
            <div id="${containerId}-grid-root" class="flex-1 overflow-y-auto px-8 space-y-6"></div>`;
            
            container.innerHTML = controlsHTML;
            renderGrid(containerId);
            setTimeout(() => updateScrollState(containerId), 100);
            window.addEventListener('resize', () => updateScrollState(containerId));
        }

        window.updateScrollState = (cid) => {
            const el = document.getElementById(`filter-scroll-${cid}`);
            const fade = document.getElementById(`fade-right-${cid}`);
            if (!el || !fade) return;
            const isOverflowing = el.scrollWidth > el.clientWidth;
            const isAtEnd = Math.abs(el.scrollWidth - el.clientWidth - el.scrollLeft) < 2;
            if (isOverflowing && !isAtEnd) fade.classList.remove('opacity-0'); else fade.classList.add('opacity-0');
        };

        function renderGrid(containerId) {
            const root = document.getElementById(`${containerId}-grid-root`);
            if(!root) return;
            let html = '';
            const keysToRender = appState.filters.onlyTeam ? ['team'] : Object.keys(rawData);
            
            keysToRender.forEach(key => {
                const section = rawData[key];
                let items = filterItems(section.items);
                if (items.length === 0) return;

                if (appState.filters.onlyTeam) {
                    const cardsHTML = items.map(item => getCardHTML(item)).join('');
                    html += `<div class="grid grid-cols-5 gap-4">${cardsHTML}</div>`;
                } else {
                    const THRESHOLD = 5;
                    let displayedItems = items;
                    let showButton = false;
                    let hiddenCount = 0;
                    if (!appState.expandedSections[key] && items.length > THRESHOLD) {
                        displayedItems = items.slice(0, 4);
                        showButton = true;
                        hiddenCount = items.length - 4;
                    }
                    const cardsHTML = displayedItems.map(item => getCardHTML(item)).join('');
                    const previewHTML = showButton ? getPreviewHTML(items.slice(4,13), key, containerId, hiddenCount) : '';
                    html += `
                    <div class="mt-8">
                        <div class="sticky top-0 z-20 py-3 mb-2 flex items-center justify-between backdrop-blur-md border-b border-transparent" style="background-color: rgba(21, 22, 28, 0.95);">
                            <h2 class="text-[15px] font-semibold tracking-wide text-[var(--text-header)]">${section.title}</h2>
                            ${items.length > THRESHOLD ? `<button onclick="toggleSection('${key}', '${containerId}')" class="flex items-center gap-1.5 text-[13px] font-medium text-[var(--accent-purple)] hover:text-[#c4b5fd]"><span class="font-medium">${appState.expandedSections[key] ? 'Collapse' : `See ${hiddenCount} More`}</span><i data-lucide="${appState.expandedSections[key] ? 'chevron-up' : 'chevron-right'}" class="w-3 h-3"></i></button>` : ''}
                        </div>
                        <div class="grid grid-cols-5 gap-4">${cardsHTML}${previewHTML}</div>
                    </div>`;
                }
            });
            root.innerHTML = html || '<div class="py-12 text-center text-[var(--text-muted)] italic">No models match the selected filters.</div>';
            lucide.createIcons();
            updateActiveButtons(containerId);
        }

        window.handleSearch = (val) => { appState.searchQuery = val; refreshGrid(); };
        
        window.toggleBooleanFilter = (key) => { 
            appState.filters[key] = !appState.filters[key];
            if(appState.filters[key]) showToast(`Filtering by ${key === 'onlyTeam' ? 'My Team' : 'Favorites'}`);
            refreshGrid(); 
        };
        
        window.toggleFilterSet = (setKey, val) => { 
            const set = appState.filters[setKey]; 
            if(set.has(val)) set.delete(val); 
            else { set.add(val); showToast(`Filtering by ${val}`); }
            refreshGrid(); 
        };
        
        window.setDateFilter = (days) => { 
            appState.filters.dateRangeDays = days; 
            if(days !== 'all') showToast(`Filtering by Last ${days} Days`);
            refreshGrid(); 
        };
        
        window.setSort = (type) => { appState.sort = type; const labels = document.querySelectorAll('.sort-btn-label'); const map = { 'recent': 'Recently Used', 'oldest': 'Oldest First', 'az': 'Name (A-Z)', 'za': 'Name (Z-A)' }; labels.forEach(l => l.innerText = map[type]); refreshGrid(); };
        window.toggleSection = (key, cid) => { appState.expandedSections[key] = !appState.expandedSections[key]; renderGrid(cid); };
        
        // SELECTION LOGIC
        window.selectModel = (id) => {
            let selectedItem = null;
            Object.values(rawData).forEach(section => {
                const found = section.items.find(i => i.id === id);
                if(found) selectedItem = found;
            });
            if(!selectedItem) return;
            const titleEl = document.getElementById('selected-model-title');
            const authorEl = document.getElementById('selected-model-author');
            const iconEl = document.getElementById('selected-model-icon');
            if(titleEl) titleEl.innerText = selectedItem.title;
            if(authorEl) authorEl.innerText = selectedItem.author;
            if(iconEl) { iconEl.innerText = ''; iconEl.style.backgroundImage = `url(${selectedItem.image})`; iconEl.classList.add('bg-cover', 'bg-center'); }
            closeModal();
        };

        function refreshGrid() { const active = document.getElementById('modal-overlay').classList.contains('hidden') ? 'page-dashboard-container' : 'modal-dashboard-container'; renderGrid(active); }
        
        function updateActiveButtons(cid) {
            const toggle = (id, c, activeClass = 'btn-active') => { const el = document.getElementById(id); if(el) c ? el.classList.add(activeClass) : el.classList.remove(activeClass); };
            toggle(`${cid}-btn-team`, appState.filters.onlyTeam);
            toggle(`${cid}-btn-tags`, appState.filters.selectedTags.size > 0);
            toggle(`${cid}-btn-caps`, appState.filters.selectedCaps.size > 0);
            toggle(`${cid}-btn-auth`, appState.filters.selectedAuthors.size > 0);
            toggle(`${cid}-btn-date`, appState.filters.dateRangeDays !== 'all');
            toggle(`${cid}-btn-fav`, appState.filters.onlyFavorites);
        }

        function navigateTo(viewId) {
            const navHome = document.getElementById('nav-home'); const navModels = document.getElementById('nav-models');
            if (viewId === 'session') { document.getElementById('view-session').classList.remove('hidden'); document.getElementById('view-models').classList.add('hidden'); navHome.classList.add('bg-white/10', 'text-white'); navModels.classList.remove('bg-white/10', 'text-white'); } 
            else if (viewId === 'models') { document.getElementById('view-session').classList.add('hidden'); document.getElementById('view-models').classList.remove('hidden'); navModels.classList.add('bg-white/10', 'text-white'); navHome.classList.remove('bg-white/10', 'text-white'); initDashboard('page-dashboard-container'); }
        }
        function openModal() { const overlay = document.getElementById('modal-overlay'); const content = document.getElementById('modal-content'); overlay.classList.remove('hidden'); setTimeout(() => { overlay.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10); initDashboard('modal-dashboard-container'); }
        function closeModal() { const overlay = document.getElementById('modal-overlay'); const content = document.getElementById('modal-content'); overlay.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95'); setTimeout(() => overlay.classList.add('hidden'), 200); }
        window.toggleDropdown = (e, id) => { e.stopPropagation(); const btn = e.currentTarget; const dropdown = document.getElementById(id); const isVisible = dropdown.classList.contains('show'); document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show')); if(!isVisible) { const rect = btn.getBoundingClientRect(); dropdown.style.top = (rect.bottom + 8) + 'px'; dropdown.style.left = rect.left + 'px'; if(id === 'dropdown-sort') { dropdown.style.display = 'block'; const dw = dropdown.offsetWidth; dropdown.style.display = ''; dropdown.style.left = (rect.right - dw) + 'px'; } dropdown.classList.add('show'); } };
        window.closeAllDropdowns = (e) => { if (e.target.closest('.dropdown-menu') || e.target.closest('button[onclick^="toggleDropdown"]')) return; document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show')); };
        initApp();
    </script>
</body>
</html>
